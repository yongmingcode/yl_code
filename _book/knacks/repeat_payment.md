# 订单支付问题引入
线上购物已经成为当代年轻人生活的重要组成部分。

商品加入购物车 -> 提交订单 -> 进入订单详情 -> 确认支付。

这之间的问题很多，本篇文章主要对其中的一个问题进行放大讲解：用户点击支付以后，由于网络、事务失败等原因，用户账户（如支付宝）中的钱扣过了，可是系统中订单状态还是未支付，用户再次点击支付，这样，就造成了重复支付的问题。

# 问题分析
我们先来看一下支付流程：

![简单下单流程](/images/knacks/repeat_payment/make_order_process.png)

上图是一个可能造成用户重复支付的支付流程，我们需要对这个流程进行改进，进而解决重复支付的问题。

# 问题解决
下图通过幂等性操作，对重复支付问题进行了解决：

![简单下单流程](/images/knacks/repeat_payment/prevent_repeat_payment.png)

> 上面的流程图极为模糊，内容可以勉强看清，希望读者可以自己动手画一下

下面来一起对上图进行分析：
1. 用户下完单去支付，如果ack为0，则表明第一次进行支付操作；
2. 将ack置为1，请求三方支付api；
3. 支付成功，ack置为2，订单状态置为已支付。

情况一：如果支付失败，用户重新点击去支付：
1. 重新支付，ack为1，则调用三方接口查询该笔订单是否支付成功；
2. 支付成功，ack置为2，订单状态置为已支付。

\* 注：三方查询可以通过订单对应的支付流水号进行查询。根据n值判断，如果3次支付都失败，则会触发系统的报警系统。

情况二：如果支付失败，用户重新点击去支付：
1. 重新支付，ack为2，这是为什么呢？唯一的解释就是在扣款完成后，第三方（如支付宝）回调我们，我们在回调函数中对订单ack进行了修改。
2. 支付成功，订单状态置为已支付。

情况三：如果支付失败，用户重新点击去支付：
1. 重新支付，ack不是0、1、2中的任何一个，则表明系统出问题了，进行报警操作。

# 总结
上面通过幂等性操作，保证了用户支付的唯一性，解决了用户重复支付的问题。

用户下单流程中有许多坑，本文旨在提供了一个对用户重复支付问题的解决思路，如对上述解决思路有疑问或者不同见解，欢迎在下方留言探讨。
